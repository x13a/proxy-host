{
    # debug
    admin off
    servers {
        # import "./signal_globals.caddy"
    }
}

# import "./signal_sites.caddy"

(authorization) {
    @unauthorized not header X-Auth-Token {$CDN_AUTH_TOKEN}
    handle @unauthorized {
        abort
    }
}

(proxy_handler) {
    encode
    root * /www
    route {
        reverse_proxy {$PANEL_PATH}* {$PANEL}:{$PANEL_PORT}
        reverse_proxy {$SUBSCRIPTION_PATH}/* {$PANEL}:{$SUBSCRIPTION_PORT}
        reverse_proxy {$PROXY_XHTTP_PATH}* {$PANEL}:{$PROXY_XHTTP_PORT}
        reverse_proxy {$PROXY_XHTTP_WARP_PATH}* {$PANEL}:{$PROXY_XHTTP_WARP_PORT}
        reverse_proxy {$PROXY_WEBSOCKET_PATH}* {$PANEL}:{$PROXY_WEBSOCKET_PORT}
        reverse_proxy {$PROXY_WEBSOCKET_WARP_PATH}* {$PANEL}:{$PROXY_WEBSOCKET_WARP_PORT}
        file_server
    }
}

www.{$DOMAIN} {
    import authorization
    redir https://{$DOMAIN}{uri}
}

{$DOMAIN} {
    import authorization
    import proxy_handler
}

{$ORIGIN_SUBDOMAIN}.{$DOMAIN} {
    import authorization
    import proxy_handler
}

{$CLOUDFLARE_SUBDOMAIN}.{$DOMAIN} {
    import authorization
    import proxy_handler
}

{$IP_SUBDOMAIN}.{$DOMAIN} {
    encode
    templates
    respond "{{.RemoteIP}}"
}

http://localhost {
    respond "OK"
}
