name: Update geovex/tgp tag in docker compose

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

env:
  COMPOSE_PATH: ./telegram/tgp/compose.yml

jobs:
  check-and-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v5

      - name: Get latest tag from geovex/tgp
        id: get_tag
        run: |
          tag=$(curl -s https://api.github.com/repos/geovex/tgp/tags | jq -r '.[0].name')
          echo "latest_tag=$tag" >> $GITHUB_OUTPUT
          echo "Latest tag: $tag"

      - name: Get current tag from docker compose
        id: current_tag
        run: |
          current=$(grep -oE 'geovex/tgp.git#v[0-9]+\.[0-9]+\.[0-9]+' ${{ env.COMPOSE_PATH }} | sed 's/.*#//')
          echo "current_tag=$current" >> $GITHUB_OUTPUT
          echo "Current tag: $current"

      - name: Compare tags
        id: compare
        run: |
          if [ "${{ steps.get_tag.outputs.latest_tag }}" != "${{ steps.current_tag.outputs.current_tag }}" ]; then
            echo "update_needed=true" >> $GITHUB_OUTPUT
          else
            echo "update_needed=false" >> $GITHUB_OUTPUT
          fi

      - name: Update docker compose
        if: steps.compare.outputs.update_needed == 'true'
        run: |
          sed -i "s|geovex/tgp.git#${{ steps.current_tag.outputs.current_tag }}|geovex/tgp.git#${{ steps.get_tag.outputs.latest_tag }}|" docker-compose.yml
          echo "Updated to ${{ steps.get_tag.outputs.latest_tag }}"

      - name: Commit and push changes
        if: steps.compare.outputs.update_needed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add ${{ env.COMPOSE_PATH }}
          git commit -m "Update geovex/tgp version to ${{ steps.get_tag.outputs.latest_tag }}"
          git push
